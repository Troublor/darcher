{"version":3,"sources":["webpack://@darcher/misc/../darcher-helpers-browser/dist/index.js","webpack://@darcher/misc/../darcher-helpers-browser/dist/log.js","webpack://@darcher/misc/../darcher-helpers-browser/dist/utility.js","webpack://@darcher/misc/./src/trace-instrument.ts","webpack://@darcher/misc/webpack/bootstrap","webpack://@darcher/misc/webpack/startup"],"names":["__createBinding","this","Object","create","o","m","k","k2","undefined","defineProperty","enumerable","get","__exportStar","exports","p","prototype","hasOwnProperty","call","value","Logger","module","level","parseLog","message","context","_a","now","Date","logTime","getMonth","toString","padStart","getDay","getHours","getMinutes","getSeconds","getMilliseconds","padEnd","slice","colored","payload","contextLiteral","key","Level","levelString","log","ERROR","console","error","WARN","warn","INFO","info","DEBUG","debug","lvl","prettifyHash","hash","startIndex","startsWith","substring","length","logger","oneTimeWebSocketRequest","url","data","Promise","resolve","reject","ws","WebSocket","onopen","send","JSON","stringify","onerror","ev","onmessage","msg","parse","close","traceSendAsync","method","params","callback","traceCache","stack","includes","Error","captureStackTrace","Proxy","apply","target","thisArg","argArray","gas","split","map","item","trim","filter","window","traceHistories","push","i","from","to","err","type","result","traceObj","__webpack_module_cache__","__webpack_require__","moduleId","__webpack_modules__"],"mappings":"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","file":"trace-instrument.js","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\n__exportStar(require(\"./log\"), exports);\n__exportStar(require(\"./utility\"), exports);\n//# sourceMappingURL=index.js.map","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Logger = void 0;\nvar Logger = /** @class */ (function () {\n    function Logger(module, level) {\n        this.module = module;\n        this.level = level;\n    }\n    Logger.prototype.parseLog = function (level, message, context) {\n        var _a;\n        var now = new Date();\n        var month = now.getMonth().toString().padStart(2, \"0\");\n        var day = now.getDay().toString().padStart(2, \"0\");\n        var hour = now.getHours().toString().padStart(2, \"0\");\n        var minute = now.getMinutes().toString().padStart(2, \"0\");\n        var second = now.getSeconds().toString().padStart(2, \"0\");\n        var millisecond = now.getMilliseconds().toString().padEnd(3, \"0\").slice(0, 3);\n        var logTime = month + \"-\" + day + \"|\" + hour + \":\" + minute + \":\" + second + \".\" + millisecond;\n        var colored = function (level, payload) {\n            // TODO coloring in Browser Console\n            return payload;\n        };\n        var contextLiteral = \"\";\n        if (context) {\n            for (var key in context) {\n                if (context.hasOwnProperty(key)) {\n                    // @ts-ignore\n                    contextLiteral += colored(level, key) + \"=\" + ((_a = context[key]) === null || _a === void 0 ? void 0 : _a.toString()) + \" \";\n                }\n            }\n        }\n        return colored(level, Logger.Level.levelString(level).padEnd(5, \" \")) + \"[\" + logTime + \"][\" + this.module + \"] \" + message.toString().padEnd(48, \" \") + \" \" + contextLiteral;\n    };\n    Logger.prototype.log = function (level, message, context) {\n        if (this.level <= level) {\n            switch (this.level) {\n                case Logger.Level.ERROR:\n                    console.error(this.parseLog(level, message, context));\n                    break;\n                case Logger.Level.WARN:\n                    console.warn(this.parseLog(level, message, context));\n                    break;\n                case Logger.Level.INFO:\n                    console.info(this.parseLog(level, message, context));\n                    break;\n                case Logger.Level.DEBUG:\n                    console.debug(this.parseLog(level, message, context));\n                    break;\n                default:\n                    console.log(this.parseLog(level, message, context));\n            }\n        }\n    };\n    Logger.prototype.info = function (message, context) {\n        this.log(Logger.Level.INFO, message, context);\n    };\n    Logger.prototype.warn = function (message, context) {\n        this.log(Logger.Level.WARN, message, context);\n    };\n    Logger.prototype.debug = function (message, context) {\n        this.log(Logger.Level.DEBUG, message, context);\n    };\n    Logger.prototype.error = function (message, context) {\n        this.log(Logger.Level.ERROR, message, context);\n    };\n    Logger.Level = {\n        DEBUG: 1,\n        INFO: 2,\n        WARN: 3,\n        ERROR: 4,\n        levelString: function (lvl) {\n            switch (lvl) {\n                case 1:\n                    return 'DEBUG';\n                case 2:\n                    return 'INFO';\n                case 3:\n                    return 'WARN';\n                case 4:\n                    return 'ERROR';\n                default:\n                    return 'UNKNOWN';\n            }\n        }\n    };\n    return Logger;\n}());\nexports.Logger = Logger;\n//# sourceMappingURL=log.js.map","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.prettifyHash = void 0;\nfunction prettifyHash(hash) {\n    var startIndex = 0;\n    if (hash.startsWith(\"0x\")) {\n        startIndex = 2;\n    }\n    return hash.substring(startIndex, startIndex + 6) + \"\\u2026\" + hash.substring(hash.length - 6, hash.length);\n}\nexports.prettifyHash = prettifyHash;\n//# sourceMappingURL=utility.js.map","import {Logger, prettifyHash} from \"@darcher/helpers-browser\";\nimport {Data} from \"./metamask-notifier\";\n\nexport interface SendTransactionTrace {\n    hash: string,\n    stack: string[],\n}\n\nexport interface StackTraceMessage extends Data {\n    type: 'FetchStackTrace',\n    stack: string[],\n}\n\nconst logger = new Logger(\"Trace\", Logger.Level.INFO);\n\nasync function oneTimeWebSocketRequest<T extends Data>(url: string, data: T): Promise<T> {\n    return new Promise<T>((resolve, reject) => {\n        const ws = new WebSocket(url);\n        ws.onopen = () => {\n            // send request\n            ws.send(JSON.stringify(data));\n        };\n        ws.onerror = (ev: ErrorEvent) => {\n            reject(ev);\n        }\n        ws.onmessage = (ev) => {\n            const msg = JSON.parse(ev.data) as T;\n            resolve(msg);\n            ws.close();\n        }\n    });\n}\n\nexport async function getStackTraceByCrawljax(): Promise<string[]> {\n    const resp = await oneTimeWebSocketRequest(\"ws://localhost:1237\", {\n        type: \"FetchStackTrace\",\n        stack: [],\n    } as StackTraceMessage);\n    return resp.stack;\n}\n\nexport interface TraceHistory {\n    method: string,\n    params: any[],\n    stack: string[] | null,\n}\n\ndeclare global {\n    interface Window {\n        traceHistories: TraceHistory[];\n    }\n}\nif (typeof window !== 'undefined' && !window.traceHistories) {\n    window.traceHistories = [] as TraceHistory[];\n}\n\n\nexport function traceSendAsync(method: string, params: any[], callback: Function): Function {\n    const traceCache: TraceHistory = {\n        method: method,\n        params: params,\n        stack: null,\n    };\n    if (['eth_sendTransaction', 'eth_sendRawTransaction', 'eth_estimateGas'].includes(method)) {\n        const traceObj = {stack: undefined};\n        Error.captureStackTrace(traceObj, traceSendAsync);\n        callback = new Proxy(callback, {\n            apply(target, thisArg, argArray) {\n                if (method === 'eth_estimateGas') {\n                    // save gas\n                    traceCache.params[0].gas = argArray[1];\n                    // save to history, in case there is a transaction use this call later\n                    traceCache.stack = traceObj.stack.split(/\\n/).map(item => item.trim()).filter(item => item.length > 0 && item !== \"Error\");\n                    window.traceHistories.push(traceCache);\n                } else if (['eth_sendTransaction', 'eth_sendRawTransaction'].includes(method)) {\n                    // search trace history for a possible estimateGas cache (which is more precise)\n                    for (let i = window.traceHistories.length - 1; i >= 0; i--) {\n                        const history = window.traceHistories[i];\n                        if (history.method === 'eth_estimateGas' &&\n                            history.params[0] && params[0] &&\n                            history.params[0].from === params[0].from &&\n                            history.params[0].to === params[0].to &&\n                            history.params[0].data === params[0].data\n                        ) {\n                            // delete this from history\n                            window.traceHistories = window.traceHistories.filter(value => value !== history);\n                            // use the stack trace of this cache\n                            traceCache.stack = history.stack;\n                            break;\n                        }\n                    }\n                    if (!traceCache.stack) {\n                        // no history found, use current one\n                        traceCache.stack = traceObj.stack.split(/\\n/).map(item => item.trim()).filter(item => item.length > 0 && item !== \"Error\");\n                    }\n                    // send trace to server\n                    const trace = {\n                        hash: argArray[1],\n                        stack: traceCache.stack,\n                    } as SendTransactionTrace;\n                    logger.info(\"Transaction trace\", {hash: prettifyHash(trace.hash), stack: trace.stack})\n                    const ws = new WebSocket(`ws://localhost:1236`);\n                    ws.onopen = () => {\n                        ws.send(JSON.stringify(trace));\n                    };\n                    ws.onerror = (ev: ErrorEvent) => {\n                        logger.error(\"Send transaction trace error\", {err: ev});\n                    }\n                    ws.onmessage = () => {\n                        ws.close();\n                    }\n                }\n                target.apply(thisArg, argArray);\n            },\n        });\n    }\n    return callback;\n}\n\nexport function traceSend(method: string, result: string) {\n    if ((method === 'eth_sendTransaction' || method === 'eth_sendRawTransaction')) {\n        const traceObj = {stack: undefined};\n        Error.captureStackTrace(traceObj, traceSendAsync);\n        const trace = {\n            hash: result,\n            stack: traceObj.stack.split(/\\n/).map(item => item.trim()).filter(item => item.length > 0 && item !== \"Error\"),\n        } as SendTransactionTrace;\n        logger.info(\"Transaction trace\", {hash: prettifyHash(trace.hash), stack: trace.stack});\n        const ws = new WebSocket(`ws://localhost:1236`);\n        ws.onopen = () => {\n            ws.send(JSON.stringify(trace));\n        };\n        ws.onerror = (ev: ErrorEvent) => {\n            logger.error(\"Send transaction trace error\", {err: ev});\n        }\n        ws.onmessage = () => {\n            ws.close();\n        }\n    }\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tif(__webpack_module_cache__[moduleId]) {\n\t\treturn __webpack_module_cache__[moduleId].exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// module exports must be returned from runtime so entry inlining is disabled\n// startup\n// Load entry module and return exports\nreturn __webpack_require__(846);\n"],"sourceRoot":""}